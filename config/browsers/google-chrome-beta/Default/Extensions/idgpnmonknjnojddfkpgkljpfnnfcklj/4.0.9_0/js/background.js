import { s as setPaused, a as setLocal, b as setupTabUpdatedListener, c as setSelectedProfileIndex, g as getLocal, d as getSync, i as isEmpty_1$1, f as fixProfiles, e as isUndefined_1, h as addStorageChangeListener, j as cloneDeep_1$1, k as filterEnabled, o as optimizeUrlRedirects, l as optimizeUrlFilters, m as optimizeResourceFilters, n as optimizeTabFilters, p as initProfileHooks, q as setProfilesAndIndex, P as PROFILE_VERSION, r as setProfiles, t as removeSync, u as setSync, _ as _baseIsEqual$1, v as passFilters, w as redirectUrl, x as evaluateValue, A as AppendMode } from '../profile-hook-c22d6069.js';

var C=_baseIsEqual$1;var O=function(e,t){return C(e,t)};async function R(e){return new Promise((t=>chrome.browserAction.setIcon(e,t)))}async function I(e){return new Promise((t=>chrome.browserAction.setBadgeText(e,t)))}async function E(e){return new Promise((t=>chrome.browserAction.setBadgeBackgroundColor(e,t)))}let _;async function T(e){O(_,e)||(_=e,await async function({icon:e,text:t,color:r}){await Promise.all([R({path:e}),I({text:t}),E({color:r})]);}(_));}var j={
/*!
 * cookie
 * Copyright(c) 2012-2014 Roman Shtylman
 * Copyright(c) 2015 Douglas Christopher Wilson
 * MIT Licensed
 */
parse:function(e,t){if("string"!=typeof e)throw new TypeError("argument str must be a string");var r={},o=(t||{}).decode||F,n=0;for(;n<e.length;){var i=e.indexOf("=",n);if(-1===i)break;var a=e.indexOf(";",n);if(-1===a)a=e.length;else if(a<i){n=e.lastIndexOf(";",i-1)+1;continue}var s=e.slice(n,i).trim();if(void 0===r[s]){var c=e.slice(i+1,a).trim();34===c.charCodeAt(0)&&(c=c.slice(1,-1)),r[s]=U(c,o);}n=a+1;}return r},serialize:function(e,t,r){var o=r||{},n=o.encode||V;if("function"!=typeof n)throw new TypeError("option encode is invalid");if(!M.test(e))throw new TypeError("argument name is invalid");var i=n(t);if(i&&!M.test(i))throw new TypeError("argument val is invalid");var a=e+"="+i;if(null!=o.maxAge){var s=o.maxAge-0;if(isNaN(s)||!isFinite(s))throw new TypeError("option maxAge is invalid");a+="; Max-Age="+Math.floor(s);}if(o.domain){if(!M.test(o.domain))throw new TypeError("option domain is invalid");a+="; Domain="+o.domain;}if(o.path){if(!M.test(o.path))throw new TypeError("option path is invalid");a+="; Path="+o.path;}if(o.expires){var c=o.expires;if(!function(e){return "[object Date]"===q.call(e)||e instanceof Date}(c)||isNaN(c.valueOf()))throw new TypeError("option expires is invalid");a+="; Expires="+c.toUTCString();}o.httpOnly&&(a+="; HttpOnly");o.secure&&(a+="; Secure");if(o.priority){switch("string"==typeof o.priority?o.priority.toLowerCase():o.priority){case"low":a+="; Priority=Low";break;case"medium":a+="; Priority=Medium";break;case"high":a+="; Priority=High";break;default:throw new TypeError("option priority is invalid")}}if(o.sameSite){switch("string"==typeof o.sameSite?o.sameSite.toLowerCase():o.sameSite){case!0:a+="; SameSite=Strict";break;case"lax":a+="; SameSite=Lax";break;case"strict":a+="; SameSite=Strict";break;case"none":a+="; SameSite=None";break;default:throw new TypeError("option sameSite is invalid")}}return a}},q=Object.prototype.toString,M=/^[\u0009\u0020-\u007e\u0080-\u00ff]+$/;function F(e){return -1!==e.indexOf("%")?decodeURIComponent(e):e}function V(e){return encodeURIComponent(e)}function U(e,t){try{return t(e)}catch(t){return e}}var D={exports:{}},N={decodeValues:!0,map:!1,silent:!1};function B(e){return "string"==typeof e&&!!e.trim()}function W(e,t){var r=e.split(";").filter(B),o=r.shift().split("="),n=o.shift(),i=o.join("=");t=t?Object.assign({},N,t):N;try{i=t.decodeValues?decodeURIComponent(i):i;}catch(e){console.error("set-cookie-parser encountered an error while decoding a cookie with value '"+i+"'. Set options.decodeValues to false to disable this feature.",e);}var a={name:n,value:i};return r.forEach((function(e){var t=e.split("="),r=t.shift().trimLeft().toLowerCase(),o=t.join("=");"expires"===r?a.expires=new Date(o):"max-age"===r?a.maxAge=parseInt(o,10):"secure"===r?a.secure=!0:"httponly"===r?a.httpOnly=!0:"samesite"===r?a.sameSite=o:a[r]=o;})),a}function $(e,t){if(t=t?Object.assign({},N,t):N,!e)return t.map?{}:[];if(e.headers&&e.headers["set-cookie"])e=e.headers["set-cookie"];else if(e.headers){var r=e.headers[Object.keys(e.headers).find((function(e){return "set-cookie"===e.toLowerCase()}))];r||!e.headers.cookie||t.silent||console.warn("Warning: set-cookie-parser appears to have been called on a request object. It is designed to parse Set-Cookie headers from responses, not Cookie headers from requests. Set the option {silent: true} to suppress this warning."),e=r;}if(Array.isArray(e)||(e=[e]),(t=t?Object.assign({},N,t):N).map){return e.filter(B).reduce((function(e,r){var o=W(r,t);return e[o.name]=o,e}),{})}return e.filter(B).map((function(e){return W(e,t)}))}D.exports=$;var z=D.exports.parse=$;D.exports.parseString=W,D.exports.splitCookiesString=function(e){if(Array.isArray(e))return e;if("string"!=typeof e)return [];var t,r,o,n,i,a=[],s=0;function c(){for(;s<e.length&&/\s/.test(e.charAt(s));)s+=1;return s<e.length}for(;s<e.length;){for(t=s,i=!1;c();)if(","===(r=e.charAt(s))){for(o=s,s+=1,c(),n=s;s<e.length&&"="!==(r=e.charAt(s))&&";"!==r&&","!==r;)s+=1;s<e.length&&"="===e.charAt(s)?(i=!0,s=n,a.push(e.substring(t,o)),t=s):s=o+1;}else s+=1;(!i||s>=e.length)&&a.push(e.substring(t,e.length));}return a};const G="toggle_pause",J="switch_to_profile_1",X="switch_to_profile_2",K="switch_to_profile_3",Q="switch_to_profile_4";async function Y(e,t){t<e.profiles.length&&await setSelectedProfileIndex(t);}const Z=["browser_action"],ee={};async function te(){await async function(){return new Promise((e=>chrome.contextMenus.removeAll(e)))}(),await async function(e){return new Promise((t=>chrome.contextMenus.create(e,t)))}({id:"pause",title:"Pause",contexts:Z});}async function re(e,{title:t,onclick:r}){ee[e]!==t&&(ee[e]=t,await async function(e,t){return new Promise((r=>chrome.contextMenus.update(e,t,r)))}(e,{title:t,contexts:Z,onclick:r}));}function oe(e){return !e.isPaused}function ne({appendMode:e,originalValue:t,newValue:r}){switch(e){case AppendMode.COMMA_SEPARATED_APPEND:return t?t+","+r:r;case AppendMode.APPEND:return t+r;default:return r}}function ie(e,t,r,o){if(!r||!r.length)return;const n={};for(let e=0;e<o.length;e++){n[o[e].name.toLowerCase()]=e;}for(const t of r){const r=t.name.toLowerCase(),i=n[r];if(!t.value&&void 0!==i&&!t.sendEmptyHeader){o[i].needRemoval=!0;continue}const a=evaluateValue({value:t.value,url:e,oldValue:void 0!==i?o[i].value:void 0});void 0!==i?o[i].value=ne({appendMode:t.appendMode,originalValue:o[i].value,newValue:a}):(o.push({name:t.name,value:a}),n[r]=o.length-1);}}function ae(e,t,r,o){if(!r||!r.length)return;const n=o.find((e=>"cookie"===e.name.toLowerCase())),i=j.parse(n?n.value:"");for(const e of r)e.value||void 0===i[e.name]||e.sendEmptyHeader?i[e.name]=e.value:delete i[e.name];const a=Object.entries(i).map((([e,t])=>`${e}=${encodeURIComponent(t)}`)).join("; ");if(n)n.value=a,a||(n.needRemoval=!0);else {const e={name:"cookie",value:a};a||(e.needRemoval=!0),o.push(e);}}function se(e,t,r,o){if(!r||!r.length)return;const n=[];let i={};for(let e=0;e<o.length;e++){const t=o[e];if("set-cookie"===t.name.toLowerCase()){const r=z(t.value);for(const e of r)i[e.name]=e;n.push(e);}}for(const e of r)e.attributeOverride||!i[e.name]?i[e.name]=e:i[e.name].value=e.value;n.reverse();for(const[e,t]of Object.entries(i)){const r=j.serialize(e,t.value,t);if(n.length>0){o[n.pop()].value=r;}else o.push({name:"set-cookie",value:r});}}var ce=function(e){return void 0===e};async function le(e){let t=await async function(){let e,t=await getLocal();if(!t.profiles){const r=await getSync(),o=r?Object.keys(r):[];o.sort(),o.length>0&&(t={profiles:r[o[o.length-1]],selectedProfile:0,savedToCloud:!0},e=!0);}return isEmpty_1$1(t.profiles)&&(t.profiles=[]),fixProfiles(t.profiles)&&(e=!0),(isUndefined_1(t.selectedProfile)||t.selectedProfile<0||t.selectedProfile>=t.profiles.length)&&(t.selectedProfile=t.profiles.length-1,e=!0),e&&await setLocal(t),t}(),r=ue(t);await e(r),addStorageChangeListener((async o=>{const i=!ce(o.profiles);if(i){let e=o.profiles.newValue;if(ce(e)&&(e=[]),fixProfiles(e))return void await setProfiles(e)}for(const[e,r]of Object.entries(o))t[e]=r.newValue;(i||o.selectedProfile)&&(r=ue(t)),await e(r),i&&await async function(e){const t=await getSync(),r=t?Object.keys(t):[];r.sort(),r.length>=20&&await removeSync(r.slice(0,r.length-20));if(0===r.length||!O(t[r[r.length-1]],e.profiles)){const t={};t[Date.now()]=e.profiles,await setSync(t);}}(t);}));}function ue(e){const t=[];let r;if(e.profiles){const o=e.profiles;for(const[n,i]of o.entries()){if(n!==e.selectedProfile&&!i.alwaysOn)continue;const o=cloneDeep_1$1(i);o.headers=filterEnabled(o.headers),o.respHeaders=filterEnabled(o.respHeaders),o.cookieHeaders=filterEnabled(o.cookieHeaders),o.setCookieHeaders=filterEnabled(o.setCookieHeaders),o.urlReplacements=optimizeUrlRedirects(o.urlReplacements),o.urlFilters=optimizeUrlFilters(o.urlFilters),o.excludeUrlFilters=optimizeUrlFilters(o.excludeUrlFilters),o.resourceFilters=optimizeResourceFilters(o.resourceFilters),o.tabFilters=optimizeTabFilters(o.tabFilters),o.tabGroupFilters=optimizeTabFilters(o.tabGroupFilters),o.windowFilters=optimizeTabFilters(o.windowFilters),n===e.selectedProfile&&(r=o),t.push(o);}}return {chromeLocal:e,activeProfiles:t,selectedActiveProfile:r}}const fe="EXISTS",de="IMPORT",pe="SWITCH_TO_LATEST",he="PROFILES";const me={};function we(e,t){me[e]||chrome.webRequest[e].addListener(t.callback,t.filter,t.extraInfoSpec);}function ge(e,t){me[e]&&chrome.webRequest[e].removeListener(t);}initProfileHooks();const ve=["<all_urls>"];let ye,be={isPaused:!0},ke=[];function Pe(e){return function({chromeLocal:e,activeProfiles:t,details:r}){if(oe(e)){let e=r.url;for(const o of t)passFilters({url:e,type:r.type,tabId:r.tabId,profile:o})&&(e=redirectUrl({urlRedirects:o.urlReplacements,url:e}));if(e!==r.url)return {redirectUrl:e}}}({chromeLocal:be,activeProfiles:ke,details:e})}function xe(e){return function({chromeLocal:e,activeProfiles:t,details:r}){if(oe(e)&&t.length>0){for(const e of t)passFilters({url:r.url,type:r.type,tabId:r.tabId,profile:e})&&(ie(r.url,0,e.headers,r.requestHeaders),ae(r.url,0,e.cookieHeaders,r.requestHeaders),r.requestHeaders=r.requestHeaders.filter((e=>!e.needRemoval)));return {requestHeaders:r.requestHeaders}}}({chromeLocal:be,activeProfiles:ke,details:e})}function He(e){return function({chromeLocal:e,activeProfiles:t,details:r}){if(oe(e)&&t.length>0){const e=r.responseHeaders||[];let o;for(const n of t)passFilters({url:r.url,type:r.type,tabId:r.tabId,profile:n})&&(o||(o=cloneDeep_1$1(e)),ie(r.url,0,n.respHeaders,o),se(r.url,0,n.setCookieHeaders,o),o=o.filter((e=>!e.needRemoval)));if(o&&!O(o,e))return {responseHeaders:o}}}({chromeLocal:be,activeProfiles:ke,details:e})}function Se(){ke.find((e=>e.urlReplacements.length>0))?we("onBeforeRequest",{callback:Pe,filter:{urls:ve},extraInfoSpec:["blocking"]}):function(e){ge("onBeforeRequest",e);}(Pe),ke.find((e=>e.headers.length>0||e.cookieHeaders.length>0))?function(e,t){we("onBeforeSendHeaders",{callback:e,filter:{urls:t},extraInfoSpec:["requestHeaders","blocking","extraHeaders"]});}(xe,ve):function(e){ge("onBeforeSendHeaders",e);}(xe),ke.find((e=>e.respHeaders.length>0||e.setCookieHeaders.length>0))?function(e,t){we("onHeadersReceived",{callback:e,filter:{urls:t},extraInfoSpec:["responseHeaders","blocking","extraHeaders"]});}(He,ve):function(e){ge("onHeadersReceived",e);}(He);}async function Le(e,t){const o=await async function({chromeLocal:e,request:t}){switch(console.log("Received message",t),t.type){case fe:{const e=chrome.runtime.getManifest();return {success:!0,maxSupportedProfileVersion:PROFILE_VERSION,modHeaderVersion:e.version}}case de:{const r=[JSON.parse(t.profile)];fixProfiles(r);const o=[...e.profiles,...r];return await setProfilesAndIndex(o,o.length-1),{success:!0}}case pe:return await setSelectedProfileIndex(e.profiles.length-1),{success:!0};case he:return {success:!0,profiles:e.profiles,selectedProfileIndex:e.selectedProfile};default:return}}({chromeLocal:be,request:e});o&&t(o);}chrome.runtime.onMessageExternal.addListener((async(e,t,r)=>{!t.origin||t.origin.startsWith("https://modheader.com")?await Le(e,r):r({error:"Unsupported origin"});})),chrome.commands.onCommand.addListener((async e=>{await async function(e,r){switch(r){case G:await setPaused(!e.isPaused);break;case J:await Y(e,0);break;case X:await Y(e,1);break;case K:await Y(e,2);break;case Q:await Y(e,3);}}(be,e);})),window.saveToStorage=function(e){return setLocal(e)},async function(){await setupTabUpdatedListener(),await te(),await le((async e=>{be=e.chromeLocal,ke=e.activeProfiles,ye=e.selectedActiveProfile,Se(),await async function({chromeLocal:e,activeProfiles:t,selectedActiveProfile:r}){if(e.isPaused)await T({icon:"images/icon_bw.png",text:"❚❚",color:"#666"});else {let e=0;for(const r of t)e+=r.headers.length+r.respHeaders.length+r.cookieHeaders.length+r.setCookieHeaders.length+r.urlReplacements.length;0===e?await T({icon:"images/icon_bw.png",text:"",color:"#fff"}):await T({icon:"images/icon.png",text:e.toString(),color:r.backgroundColor});}}({chromeLocal:be,activeProfiles:ke,selectedActiveProfile:ye}),await async function(e){e.isPaused?await re("pause",{title:"Unpause ModHeader",onclick:()=>setPaused(!1)}):await re("pause",{title:"Pause ModHeader",onclick:()=>setPaused(!0)});}(be);}));}();
