(()=>{"use strict";window.EdgeTranslateBannerController=new class{constructor(){this.channel=new class{constructor(){this._services=new Map,this._eventManager=new class{constructor(){this._handlerID=1,this._eventToHandlerIDs=new Map,this._handlerIDToHandler=new Map}on(e,t){const r=this._allocHandlerID();this._handlerIDToHandler.set(r,t),this._eventToHandlerIDs.has(e)?this._eventToHandlerIDs.get(e).add(r):this._eventToHandlerIDs.set(e,new Set([r]));let n=!1;return(()=>{n?console.warn("You shouldn't call the canceler more than once!"):(n=!0,this._off(e,r))}).bind(this)}emit(e,t,r){const n=this._eventToHandlerIDs.get(e);if(n)for(const e of n){const n=this._handlerIDToHandler.get(e);n&&n(t,r)}}_allocHandlerID(){for(;this._handlerIDToHandler.has(this._handlerID);)this._handlerID=(this._handlerID+1)%Number.MAX_SAFE_INTEGER;return this._handlerID}_off(e,t){const r=this._eventToHandlerIDs.get(e);r&&r.delete(t),this._handlerIDToHandler.delete(t)}},chrome.runtime.onMessage.addListener(((e,t,r)=>{let n=JSON.parse(e);if(n&&n.type)switch(n.type){case"event":this._eventManager.emit(n.event,n.detail,t),r&&r();break;case"service":{const e=this._services.get(n.service);if(!e)break;return e(n.params,t).then((e=>r&&r(e))),!0}default:console.error(`Unknown message type: ${e.type}`)}else console.error(`Bad message: ${e}`)}).bind(this))}provide(e,t){this._services.set(e,t)}request(e,t){const r=JSON.stringify({type:"service",service:e,params:t});return new Promise(((e,t)=>{chrome.runtime.sendMessage(r,(r=>{chrome.runtime.lastError?t(chrome.runtime.lastError):e(r)}))}))}requestToTab(e,t,r){const n=this._getTabMessageSender();return n?n(e,JSON.stringify({type:"service",service:t,params:r})):Promise.reject("Can not send message to tabs in current context!")}on(e,t){return this._eventManager.on(e,t)}emit(e,t){let r=JSON.stringify({type:"event",event:e,detail:t});chrome.runtime.sendMessage(r,(()=>{chrome.runtime.lastError&&console.error(chrome.runtime.lastError)}))}emitToTabs(e,t,r){const n=this._getTabMessageSender();if(!n)return void console.error("Can not send message to tabs in current context!");"number"==typeof e&&(e=[e]);const s=JSON.stringify({type:"event",event:t,detail:r});for(let t of e)n(t,s).catch((e=>console.error(e)))}_getTabMessageSender(){return chrome.tabs&&chrome.tabs.sendMessage?(e,t)=>new Promise(((r,n)=>{chrome.tabs.sendMessage(e,t,(e=>{chrome.runtime.lastError?n(chrome.runtime.lastError):r(e)}))})):null}},this.currentTranslator=null,this.canceller=null,this.addListeners()}addListeners(){this.channel.on("start_page_translate",(e=>{switch(e.translator){case"google":{this.currentTranslator="google";let e=this.googleMessageHandler.bind(this);window.addEventListener("message",e),this.canceller=(()=>{window.removeEventListener("message",e)}).bind(this);break}case"youdao":this.currentTranslator="youdao",this.canceller=this.channel.on("page_translate_event",this.youdaoMessageHandler.bind(this))}}).bind(this)),this.channel.on("command",(e=>{"toggle_page_translate_banner"===e.command&&this.toggleBanner()}))}toggleBannerFrame(e){switch(this.currentTranslator){case"google":{let t=document.getElementById(":0.container");if(null!=t)return void(t.style.visibility=e?"visible":"hidden");break}case"youdao":{let t=document.getElementById("OUTFOX_BAR_WRAPPER");if(null!=t)return void(t.style.visibility=e?"visible":"hidden");break}}}movePage(e,t,r){let n=document.body.style.getPropertyValue(e);try{let s=parseInt(n,10);document.body.style.cssText=document.body.style.cssText.replace(new RegExp(`${e}:.*;`,"g"),`${e}: ${r?t:s+t}px !important;`)}catch(r){document.body.style.setProperty(e,`${t}px`,"important")}}googleMessageHandler(e){let t=JSON.parse(e.data);t.type&&"edge_translate_page_translate_event"===t.type&&"page_moved"===t.event&&(chrome.storage.sync.get("HidePageTranslatorBanner",(e=>{e.HidePageTranslatorBanner&&setTimeout((()=>{this.toggleBannerFrame(!1),this.movePage("top",0,!0)}),0)})),t.distance<=0&&(this.canceller(),this.canceller=null,this.currentTranslator=null))}youdaoMessageHandler(e){"page_moved"===e.event&&(chrome.storage.sync.get("HidePageTranslatorBanner",(t=>{t.HidePageTranslatorBanner&&setTimeout((()=>{this.toggleBannerFrame(!1),this.movePage("margin-top",-e.distance,!1)}),0)})),e.distance<=0&&(this.canceller(),this.canceller=null,this.currentTranslator=null))}toggleBanner(){this.currentTranslator&&chrome.storage.sync.get("HidePageTranslatorBanner",(e=>{switch(e.HidePageTranslatorBanner=!e.HidePageTranslatorBanner,chrome.storage.sync.set(e),this.currentTranslator){case"google":e.HidePageTranslatorBanner?(this.toggleBannerFrame(!1),this.movePage("top",0,!0)):(this.toggleBannerFrame(!0),this.movePage("top",40,!0));break;case"youdao":e.HidePageTranslatorBanner?(this.toggleBannerFrame(!1),this.movePage("margin-top",-50,!1)):(this.toggleBannerFrame(!0),this.movePage("margin-top",50,!1))}}))}}})();