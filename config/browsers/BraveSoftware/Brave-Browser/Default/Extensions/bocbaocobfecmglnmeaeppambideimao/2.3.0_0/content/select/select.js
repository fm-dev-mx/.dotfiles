(()=>{"use strict";function e(){return window.location.origin+window.location.pathname===chrome.runtime.getURL("pdf/viewer.html")}const t=new class{constructor(){this._services=new Map,this._eventManager=new class{constructor(){this._handlerID=1,this._eventToHandlerIDs=new Map,this._handlerIDToHandler=new Map}on(e,t){const n=this._allocHandlerID();this._handlerIDToHandler.set(n,t),this._eventToHandlerIDs.has(e)?this._eventToHandlerIDs.get(e).add(n):this._eventToHandlerIDs.set(e,new Set([n]));let o=!1;return(()=>{o?console.warn("You shouldn't call the canceler more than once!"):(o=!0,this._off(e,n))}).bind(this)}emit(e,t,n){const o=this._eventToHandlerIDs.get(e);if(o)for(const e of o){const o=this._handlerIDToHandler.get(e);o&&o(t,n)}}_allocHandlerID(){for(;this._handlerIDToHandler.has(this._handlerID);)this._handlerID=(this._handlerID+1)%Number.MAX_SAFE_INTEGER;return this._handlerID}_off(e,t){const n=this._eventToHandlerIDs.get(e);n&&n.delete(t),this._handlerIDToHandler.delete(t)}},chrome.runtime.onMessage.addListener(((e,t,n)=>{let o=JSON.parse(e);if(o&&o.type)switch(o.type){case"event":this._eventManager.emit(o.event,o.detail,t),n&&n();break;case"service":{const e=this._services.get(o.service);if(!e)break;return e(o.params,t).then((e=>n&&n(e))),!0}default:console.error(`Unknown message type: ${e.type}`)}else console.error(`Bad message: ${e}`)}).bind(this))}provide(e,t){this._services.set(e,t)}request(e,t){const n=JSON.stringify({type:"service",service:e,params:t});return new Promise(((e,t)=>{chrome.runtime.sendMessage(n,(n=>{chrome.runtime.lastError?t(chrome.runtime.lastError):e(n)}))}))}requestToTab(e,t,n){const o=this._getTabMessageSender();return o?o(e,JSON.stringify({type:"service",service:t,params:n})):Promise.reject("Can not send message to tabs in current context!")}on(e,t){return this._eventManager.on(e,t)}emit(e,t){let n=JSON.stringify({type:"event",event:e,detail:t});chrome.runtime.sendMessage(n,(()=>{chrome.runtime.lastError&&console.error(chrome.runtime.lastError)}))}emitToTabs(e,t,n){const o=this._getTabMessageSender();if(!o)return void console.error("Can not send message to tabs in current context!");"number"==typeof e&&(e=[e]);const r=JSON.stringify({type:"event",event:t,detail:n});for(let t of e)o(t,r).catch((e=>console.error(e)))}_getTabMessageSender(){return chrome.tabs&&chrome.tabs.sendMessage?(e,t)=>new Promise(((n,o)=>{chrome.tabs.sendMessage(e,t,(e=>{chrome.runtime.lastError?o(chrome.runtime.lastError):n(e)}))})):null}};let n=!1,o=document.createElement("div"),r=document.createElement("img");r.src="data:image/png;base64,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",r.style.filter="none",o.appendChild(r),o.id="edge-translate-button",o.style.backgroundColor="white",o.addEventListener("mousedown",(function(e){e.preventDefault(),e.stopPropagation(),0===e.button?m():2===e.button&&h()})),o.addEventListener("contextmenu",(e=>e.preventDefault()));let s=0,i=0,a=0,c=0,l=window,d="pageXOffset",A="pageYOffset",g="TopRight";function u(){let t,n=window.getSelection(),o="";if(n.rangeCount>0&&(o=n.toString().trim(),e()&&(o=o.replace(/\n/g," ")),n.getRangeAt(n.rangeCount-1).endContainer!==document.documentElement)){let e=n.getRangeAt(n.rangeCount-1).getBoundingClientRect();t=[e.left,e.top]}return{text:o,position:t}}function m(){let e=u();e.text&&e.text.length>0&&t.request("translate",e).then((()=>{chrome.storage.sync.get("OtherSettings",(e=>{e.OtherSettings&&e.OtherSettings.CancelTextSelection&&(window.getSelection?window.getSelection().empty?window.getSelection().empty():window.getSelection().removeAllRanges&&window.getSelection().removeAllRanges():document.selection&&document.selection.empty())})),w()}))}function h(){let e=u();e.text&&e.text.length>0&&t.request("pronounce",{text:e.text,language:"auto"})}function w(){n&&(document.documentElement.removeChild(o),n=!1)}function f(){if(n){let e=s-l[d],t=i-l[A];o.style.left=`${a+e}px`,o.style.top=`${c+t}px`}}chrome.storage.sync.get("LayoutSettings",(e=>{(e.LayoutSettings||e.LayoutSettings.SelectTranslatePosition)&&(g=e.LayoutSettings.SelectTranslatePosition)})),chrome.storage.onChanged.addListener(((e,t)=>{"sync"===t&&e.LayoutSettings&&(g=e.LayoutSettings.newValue.SelectTranslatePosition)})),window.addEventListener("DOMContentLoaded",(()=>{async function t(e,t=!1){(function(){let e=window.getSelection(),t=e.toString().trim();return t.length>0&&(e.anchorNode.nodeType===Node.TEXT_NODE||e.focusNode.nodeType===Node.TEXT_NODE)&&!(window.isDisplayingResult&&window.translateResult.originalText===t)})()&&(await new Promise((e=>{chrome.storage.sync.get("blacklist",(t=>{let n=window.location.href,o=t.blacklist;return e(o&&(o.domains[function(e){if(e){let t=/.+:\/+([\w.-]+).*/,n=e.match(t);if(n)return n[1]}return""}(n)]||o.urls[n]))}))}))||chrome.storage.sync.get("OtherSettings",(r=>{if(!r.OtherSettings)return;let u=r.OtherSettings;u.TranslateAfterSelect||t&&u.TranslateAfterDblClick?m():u.SelectTranslate&&function(e){document.documentElement.appendChild(o);let t,r;switch(g){default:case"TopRight":t=10,r=-20-o.clientHeight;break;case"TopLeft":t=-10-o.clientWidth,r=-20-o.clientHeight;break;case"BottomRight":t=10,r=20;break;case"BottomLeft":t=-10-o.clientWidth,r=20}let u=e.x+t,m=e.y+r;(u<=0||u+o.clientWidth>window.innerWidth)&&(u=e.x-t-o.clientWidth),(m<=0||m+o.clientHeight>window.innerHeight)&&(m=e.y-r-o.clientHeight),o.style.top=`${m}px`,o.style.left=`${u}px`,s=l[d],i=l[A],a=u,c=m,n=!0}(e)})))}e()&&(l=document.getElementById("viewerContainer"),d="scrollLeft",A="scrollTop"),l.addEventListener("scroll",f),document.addEventListener("mousedown",(()=>{w(),function(e,t,n){let o=!1;const r=()=>{o=!0},s=n=>{!!o&&t(n),e.removeEventListener("mousemove",r),e.removeEventListener("mouseup",s)};e.addEventListener("mousemove",r),e.addEventListener("mouseup",s)}(document,(e=>{t(e)}))})),document.addEventListener("dblclick",(e=>{t(e,!0)})),document.addEventListener("click",(e=>{3===e.detail&&t(e,!0)}))})),t.provide("get_selection",(()=>Promise.resolve(u()))),t.on("command",(e=>{switch(e.command){case"translate_selected":m();break;case"pronounce_selected":h();break;case"cancel_page_translate":!function(){let e=e=>{null!=e&&e.click()},t=document.getElementById(":0.container");null!=t&&e(t.contentDocument.getElementById(":0.close")),t=document.getElementById("OUTFOX_JTR_BAR"),null!=t&&e(t.contentDocument.getElementById("OUTFOX_JTR_BAR_CLOSE"))}()}}))})();